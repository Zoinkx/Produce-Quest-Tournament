<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Produce Quest - Tournament</title>
  <meta name="referrer" content="no-referrer-when-downgrade">
  <style>
    :root{ --bg1:#fce3ec; --bg2:#ffe9e9; --bg3:#fefcfd; --primary:#ff8c94; --accent:#ffb3c1; --text:#4a4a4a; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
    body{background:linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 50%, var(--bg3) 100%);min-height:100vh;display:flex;flex-direction:column}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;flex-wrap:wrap;gap:24px;justify-content:center;align-items:stretch}
    .col{flex:1 1 520px;max-width:560px}
    .card{background:#fff;border:2px solid var(--accent);border-radius:14px;box-shadow:0 10px 30px rgba(255,179,193,.4);padding:22px}
    .title{font-size:28px;font-weight:800;color:var(--primary);text-align:center;margin:0 0 14px}
    .profile{display:grid;grid-template-columns:.9fr 2.6fr;gap:18px}
    @media (max-width: 768px){.profile{grid-template-columns:1fr}}
    .square{height:100%;aspect-ratio:1/1}
    .avatar{width:100%;height:100%;object-fit:contain;background:transparent}
    .details{background:#fff7f9;border-radius:10px;padding:12px;box-shadow:inset 0 1px 4px rgba(0,0,0,.06)}
    .details p{display:flex;justify-content:space-between;margin:6px 0;font-size:14px}
    .video{position:relative;width:100%;padding-bottom:56.25%;border-radius:12px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.1);margin-top:16px;margin-bottom:16px}
    .video iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .btn{width:100%;margin-top:12px;background:linear-gradient(90deg,var(--primary) 0%, var(--accent) 100%);color:#fff;font-weight:800;border:none;border-radius:12px;padding:12px 16px;cursor:pointer;box-shadow:0 4px 15px rgba(255,140,148,.5);transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;will-change:transform}
    .btn:hover{transform:scale(1.035);filter:hue-rotate(-8deg) saturate(1.05);box-shadow:0 6px 18px rgba(255,140,148,.55)}
    .header{background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .progress{width:100%;height:10px;border-radius:999px;background:#eee;overflow:hidden}
    .progress>div{height:100%;background:var(--accent);width:0;transition:width .4s}
    .bracket-badge{display:inline-block;padding:4px 10px;border-radius:8px;font-size:13px;font-weight:700;margin-left:8px}
    .winners-badge{background:#ffd700;color:#8b6914}
    .losers-badge{background:#c0c0c0;color:#555}
    .vs{align-self:stretch;min-width:72px;display:flex;align-items:center;justify-content:center;padding:0 8px;font-size:38px;font-weight:900;color:var(--primary)}
    .reset{width:auto;padding:10px 16px;position:fixed;right:16px;bottom:16px;z-index:999;border-radius:999px}
    @media (max-width: 768px){.vs{min-height:48px;margin:8px 0}}
    .placements-wrap{display:flex;flex-direction:column;gap:24px;align-items:center}
    .champ-wrap{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:end}
    .champ, .runner, .third{background:#fff;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);text-align:center;transition:transform .12s ease, box-shadow .12s ease}
    .champ{border:4px solid #d4af37}
    .runner{border:3px solid #c0c0c0}
    .third{border:3px solid #cd7f32}
    .champ:hover, .runner:hover, .third:hover{transform:scale(1.06);box-shadow:0 12px 28px rgba(0,0,0,.12)}
    .champ .avatar{max-width:242px}
    .runner .avatar, .third .avatar{max-width:170px}
    .rank-badge{font-weight:900;color:#ff8c94;margin-bottom:8px}
    .crown{font-size:28px;margin-left:6px}
    .list-wrap{max-width:408px;width:100%;display:flex;flex-direction:column;gap:10px}
    .place-card{display:flex;justify-content:space-between;align-items:center;background:#fff;border:2px solid #ffd6df;border-radius:14px;padding:8px 12px;box-shadow:0 4px 12px rgba(0,0,0,.06);transition:transform .15s ease, box-shadow .15s ease;min-height:54px;overflow:visible}
    .place-card:hover{transform:scale(1.5);box-shadow:0 10px 24px rgba(0,0,0,.12)}
    .place-card .avatar{width:68px;height:68px;object-fit:contain;position:relative;z-index:1}
    .place-card .title-center{flex:1;text-align:center;font-weight:900;font-size:1.05rem}
    .hide{display:none !important}
  </style>
  <script>
const RAW = [
  ["reika-takeuchi","Reika Takeuchi","https://www.youtube.com/embed/xeTEh-j1Mck?rel=0&start=3064","Reika Takeuchi.webp"],
  ["nikao-furuse","Nikao Furuse","https://www.youtube.com/embed/xeTEh-j1Mck?rel=0&start=2556","Nikao Furuse.webp"],
  ["kaede-mori","Kaede Mori","https://www.youtube.com/embed/fqJhGEPyawY?rel=0&start=1289","Kaede Mori.png"],
  ["kohime-nozaki","Kohime Nozaki","https://www.youtube.com/embed/xeTEh-j1Mck?rel=0&start=347","Kohime Nozaki.webp"],
  ["aimi-sato","Aimi Sato","https://www.youtube.com/embed/hFKhrDLBV3U?rel=0&start=500","Aimi Sato.webp"],
  ["mimi-ueki","Mimi Ueki","https://www.youtube.com/embed/fqJhGEPyawY?rel=0&start=3252","Mimi Ueki.webp"],
  ["ruri-enomoto","Ruri Enomoto","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=528","Ruri Enomoto.webp"],
  ["aimi-horinouchi","Aimi Horinouchi","https://www.youtube.com/embed/hFKhrDLBV3U?rel=0&start=755","Aimi Horinouchi.png"],
  ["karen-otsubo","Karen Otsubo","https://www.youtube.com/embed/hFKhrDLBV3U?rel=0&start=2223","Karen Otsubo.webp"],
  ["fuka-nagaike","Fuka Nagaike","https://www.youtube.com/embed/fqJhGEPyawY?rel=0&start=245","Fuka Nagaike.webp"],
  ["aira-shikano","Aira Shikano","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=918","Aira Shikano.webp"],
  ["mao-saito","Mao Saito","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=2749","Mao Saito.webp"],
  ["choko-yoshida","Choko Yoshida","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=3075","Choko Yoshida.png"],
  ["ruka-sato","Ruka Sato","https://www.youtube.com/embed/xeTEh-j1Mck?rel=0&start=1151","Ruka Sato.webp"],
  ["miyabi-yamamoto","Miyabi Yamamoto","https://www.youtube.com/embed/hFKhrDLBV3U?rel=0&start=200","Miyabi Yamamoto.png"],
  ["ren-kawakita","Ren Kawakita","https://www.youtube.com/embed/hFKhrDLBV3U?rel=0&start=879","Ren Kawakita.webp"],
  ["miyuu-sato","Miyuu Sato","https://www.youtube.com/embed/hFKhrDLBV3U?rel=0&start=1842","Miyuu Sato.webp"],
  ["yu-seto","Yu Seto","https://www.youtube.com/embed/fqJhGEPyawY?rel=0&start=493","Yu Seto.webp"],
  ["moka-kawaguchi","Moka Kawaguchi","https://www.youtube.com/embed/fqJhGEPyawY?rel=0&start=2840","Moka Kawaguchi.webp"],
  ["aimi-inuzuka","Aimi Inuzuka","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=178","Aimi Inuzuka.webp"],
  ["nana-hashimoto","Nana Hashimoto","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=321","Nana Hashimoto.webp"],
  ["saaya-takaki","Saaya Takaki","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=744","Saaya Takaki.webp"],
  ["neiro-tanaka","Neiro Tanaka","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=1162","Neiro Tanaka.png"],
  ["haruka-kakutani","Haruka Kakutani","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=1745","Haruka Kakutani.webp"],
  ["rana-iwase","Rana Iwase","https://www.youtube.com/embed/EDd_F25TbtA?rel=0&start=2172","Rana Iwase.webp"],
  ["nasuzu-koyama","Nasuzu Koyama","https://www.youtube.com/embed/xeTEh-j1Mck?rel=0&start=596","Nasuzu Koyama.webp"],
  ["kaworu-hayashi","Kaworu Hayashi","https://www.youtube.com/embed/xeTEh-j1Mck?rel=0&start=2265","Kaworu Hayashi.webp"],
  ["kaaya-yoneyama","Kaaya Yoneyama","https://www.youtube.com/embed/xeTEh-j1Mck?rel=0&start=3769","Kaaya Yoneyama.png"]];

const DETAILS = {
  "aimi-horinouchi": {"age": "18","height": "153 cm","birthday": "August 15, 2006","zodiac": "Leo","bloodType": "B","mbti": "ESFP-T","from": "Yamanashi"},
  "aimi-inuzuka": {"age": "17","height": "168 cm","birthday": "February 4, 2008","zodiac": "Aquarius","bloodType": "B","mbti": "ENFP","from": "Ishikawa"},
  "aimi-sato": {"age": "22","height": "158 cm","birthday": "December 16, 2002","zodiac": "Sagittarius","bloodType": "O","mbti": "ISFJ","from": "Tokyo"},
  "aira-shikano": {"age": "20","height": "164 cm","birthday": "June 19, 2005","zodiac": "Gemini","bloodType": "A","mbti": "ESTJ","from": "Gifu"},
  "choko-yoshida": {"age": "21","height": "163 cm","birthday": "February 9, 2004","zodiac": "Pisces","bloodType": "A","mbti": "ESFP","from": "Osaka"},
  "fuka-nagaike": {"age": "20","height": "161 cm","birthday": "April 5, 2005","zodiac": "Aries","bloodType": "B","mbti": "ESFP","from": "Chiba"},
  "haruka-kakutani": {"age": "18","height": "153 cm","birthday": "March 7, 2009","zodiac": "Pisces","bloodType": "A","mbti": "INTP","from": "Chiba"},
  "kaaya-yoneyama": {"age": "22","height": "153 cm","birthday": "January 30, 2003","zodiac": "Aquarius","bloodType": "A","mbti": "INFP","from": "Hyogo"},
  "kaede-mori": {"age": "19","height": "158 cm","birthday": "November 16, 2005","zodiac": "Scorpio","bloodType": "B","mbti": "ESFP","from": "Saitama"},
  "karen-otsubo": {"age": "20","height": "165 cm","birthday": "November 5, 2004","zodiac": "Scorpio","bloodType": "A","mbti": "INTP","from": "Fukuoka"},
  "kaworu-hayashi": {"age": "21","height": "159 cm","birthday": "January 29, 2004","zodiac": "Aquarius","bloodType": "AB","mbti": "INFP-T","from": "Kanagawa"},
  "kohime-nozaki": {"age": "23","height": "159 cm","birthday": "March 24, 2002","zodiac": "Aries","bloodType": "B","mbti": "EAFJ","from": "Osaka"},
  "mao-saito": {"age": "19","height": "147 cm","birthday": "June 10, 2006","zodiac": "Gemini","bloodType": "A","mbti": "ISFP","from": "Osaka"},
  "mimi-ueki": {"age": "17","height": "168 cm","birthday": "October 28, 2007","zodiac": "Scorpio","bloodType": "O","mbti": "ENFP","from": "Kanagawa"},
  "miyabi-yamamoto": {"age": "20","height": "160 cm","birthday": "October 28, 2004","zodiac": "Scorpio","bloodType": "O","mbti": "INFP","from": "Tokyo"},
  "miyuu-sato": {"age": "21","height": "155 cm","birthday": "December 24, 2003","zodiac": "Capricorn","bloodType": "B","mbti": "ENFP","from": "Aomori"},
  "moka-kawaguchi": {"age": "20","height": "163 cm","birthday": "May 8, 2005","zodiac": "Taurus","bloodType": "A","mbti": "ISFP","from": "Hokkaido"},
  "nana-hashimoto": {"age": "20","height": "158 cm","birthday": "September 9, 2004","zodiac": "Virgo","bloodType": "O","mbti": "ENFJ","from": "Fukuoka"},
  "nasuzu-koyama": {"age": "20","height": "154 cm","birthday": "October 11, 2004","zodiac": "Libra","bloodType": "A","mbti": "INFP","from": "Tokyo"},
  "neiro-tanaka": {"age": "19","height": "152 cm","birthday": "July 6, 2006","zodiac": "Cancer","bloodType": "AB","mbti": "ESFJ","from": "Fukuoka"},
  "nikao-furuse": {"age": "20","height": "166 cm","birthday": "July 1, 2005","zodiac": "Cancer","bloodType": "O","mbti": "ISFJ","from": "—"},
  "rana-iwase": {"age": "21","height": "164 cm","birthday": "August 1, 2004","zodiac": "Leo","bloodType": "B","mbti": "INTP","from": "Osaka"},
  "reika-takeuchi": {"age": "27","height": "168 cm","birthday": "April 8, 1998","zodiac": "Aries","bloodType": "A","mbti": "ENFP","from": "Aichi"},
  "ren-kawakita": {"age": "13","height": "158 cm","birthday": "August 3, 2011","zodiac": "Leo","bloodType": "O","mbti": "INFJ (SOMETIMES INFP!)","from": "Tokyo"},
  "ruka-sato": {"age": "19","height": "152 cm","birthday": "August 4, 2006","zodiac": "Leo","bloodType": "AB","mbti": "ESFP","from": "Tokyo"},
  "ruri-enomoto": {"age": "21","height": "160 cm","birthday": "January 20, 2004","zodiac": "Aquarius","bloodType": "O","mbti": "ENFP","from": "Osaka"},
  "yu-seto": {"age": "21","height": "152 cm","birthday": "May 15, 2004","zodiac": "Taurus","bloodType": "O","mbti": "ISFP","from": "Shizuoka"},
  "saaya-takaki": {"age": "20","height": "161 cm","birthday": "April 5, 2005","zodiac": "Aries","bloodType": "B","mbti": "ESFP","from": "Osaka"}};

const NAME_TO_URL = {
  "Reika Takeuchi": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_9f08b950-6bcf-4a1e-b0ee-9861d64d6c66.webp",
  "Nikao Furuse": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_247b39a6-0f8b-4a5b-83ca-41cec4a6bde6.webp",
  "Kaede Mori": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_59c31b13-9334-4efe-918e-94b27c8d6ef5.webp",
  "Kohime Nozaki": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_f9eac80c-0aed-4e22-9a57-3d1c3467adc1.webp",
  "Aimi Sato": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_e8eac992-dbc1-40c3-b193-46c7e80a1c5c.webp",
  "Mimi Ueki": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_df114956-a8e4-41ac-9722-f69cfa3fca82.webp",
  "Ruri Enomoto": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_96476fa4-b46c-4f23-834e-71b91d27516d.webp",
  "Aimi Horinouchi": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_32e30ae8-ac09-4560-9d2b-726b561d9a38.webp",
  "Karen Otsubo": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_5555ed52-8906-4b62-b8e6-db245c134e25.webp",
  "Fuka Nagaike": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_89f3dba7-90e2-4f33-ab0e-218cc94cd877.webp",
  "Aira Shikano": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_a8df4302-0a98-4f74-94c4-072a21750c97.webp",
  "Mao Saito": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_ad91aea3-008c-4f63-9dec-9fe0192d3fcf.webp",
  "Choko Yoshida": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_719aca00-0ed6-4b59-805b-5544538ca1fd.webp",
  "Ruka Sato": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_7e9ee581-ced9-4e38-9766-51e87475f831.webp",
  "Miyabi Yamamoto": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_d9014b31-1d9c-460a-89a7-d6cbb2d30fcf.webp",
  "Ren Kawakita": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_d7de4d58-6f66-4713-a5dc-f4e8514488f8.webp",
  "Miyuu Sato": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_dda7db5b-4a8b-42f8-af18-dbb381f3ae37.webp",
  "Yu Seto": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_6ea0baf9-fbfb-4f4f-8c51-5a85837b6e54.webp",
  "Moka Kawaguchi": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_054c291b-ebc8-4ec1-94d5-5ab3b2ebc570.webp",
  "Aimi Inuzuka": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_0f51d9df-6e1a-4aab-ba96-e349fd8e17b2.webp",
  "Nana Hashimoto": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_7018065b-10e5-4042-a567-8762e1ac53b3.webp",
  "Saaya Takaki": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_c10f4c71-415c-4bdd-bff1-aa7f6e7d302a.webp",
  "Neiro Tanaka": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_4a5a41b9-a911-4cc7-814c-f3fbd2c239be.webp",
  "Haruka Kakutani": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_f368f1a8-0d56-461d-b505-1a07189b13ee.webp",
  "Rana Iwase": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_085f717c-c381-4235-8847-0d67efe6845d.webp",
  "Nasuzu Koyama": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_daeec277-0db3-436a-8c11-70d8ddd77eb5.webp",
  "Kaworu Hayashi": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_0e246f96-bb81-472d-a7cf-d848bedd0329.webp",
  "Kaaya Yoneyama": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_65fba89b-7f50-4f64-9479-44cffcf63ea3.webp",
  "Amane Yunoki": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_56fb74eb-2627-45ef-8928-d4c854e752c1.webp",
  "Aris Kawamatsu": "https://storage.googleapis.com/studio-cms-assets/projects/moWv263zW6/s-485x485_webp_f90f4062-06b3-45ba-a1bd-d89c84a156d6.webp"
};

const imgSrc = (filename) => 'profile-pictures/' + encodeURIComponent(filename);
const CONTESTANTS = {};
RAW.forEach(([id,name,embedSrc,filename]) => {
  CONTESTANTS[id] = { id, name, filename, details: DETAILS[id] || {}, video: { embedUrl: embedSrc } };
});

const STATE_KEY = 'bracket_double_elim_v2';
let state = null;

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function initState() {
  const ids = Object.keys(CONTESTANTS);
  shuffle(ids);
  
  // Create queue-based system
  state = {
    winnersQueue: [...ids],
    losersQueue: [],
    pendingLosers: [], // Losers waiting to enter losers bracket
    eliminated: [],
    totalMatches: 0,
    currentBracket: 'winners',
    grandFinals: null,
    bracketReset: false
  };
  
  // Pad winners queue to power of 2 with nulls (BYEs)
  const nextPowerOf2 = Math.pow(2, Math.ceil(Math.log2(state.winnersQueue.length)));
  while (state.winnersQueue.length < nextPowerOf2) {
    state.winnersQueue.push(null);
  }
  
  save();
}

function save() {
  localStorage.setItem(STATE_KEY, JSON.stringify(state));
}

function load() {
  try {
    const saved = localStorage.getItem(STATE_KEY);
    if (saved) {
      state = JSON.parse(saved);
      return true;
    }
  } catch (e) {}
  initState();
  return false;
}

function getTotalMatches() {
  // Calculate actual matches needed for double elimination
  // In double elim, each person must lose twice except the winner
  const n = Object.keys(CONTESTANTS).length;
  // Upper bound: everyone loses twice except winner = 2(n-1) matches
  // But some BYEs reduce this slightly
  const nextPowerOf2 = Math.pow(2, Math.ceil(Math.log2(n)));
  const byesNeeded = nextPowerOf2 - n;
  // Approximate: (2n - 2) - some BYEs
  return (2 * n) - 2 - Math.floor(byesNeeded / 2);
}

function getCurrentMatch() {
  // Grand finals
  if (state.grandFinals) {
    return {
      bracket: 'grand',
      a: state.grandFinals.a,
      b: state.grandFinals.b
    };
  }
  
  // Winners bracket
  if (state.currentBracket === 'winners' && state.winnersQueue.length >= 2) {
    return {
      bracket: 'winners',
      a: state.winnersQueue[0],
      b: state.winnersQueue[1]
    };
  }
  
  // Losers bracket
  if (state.currentBracket === 'losers' && state.losersQueue.length >= 2) {
    return {
      bracket: 'losers',
      a: state.losersQueue[0],
      b: state.losersQueue[1]
    };
  }
  
  return null;
}

function choose(winnerId) {
  const match = getCurrentMatch();
  if (!match) return;
  
  const loserId = winnerId === match.a ? match.b : match.a;
  
  // Only increment for real matches (not BYEs)
  if (loserId !== null) {
    state.totalMatches++;
  }
  
  // Grand finals
  if (match.bracket === 'grand') {
    if (winnerId === state.grandFinals.b && !state.bracketReset) {
      // Bracket reset! Losers champ won first match
      state.bracketReset = true;
      save();
      render();
      return;
    }
    
    // Tournament complete
    state.eliminated.push(loserId);
    state.eliminated.push(winnerId);
    save();
    render();
    return;
  }
  
  // Winners bracket
  if (match.bracket === 'winners') {
    state.winnersQueue.shift(); // Remove player A
    state.winnersQueue.shift(); // Remove player B
    
    if (loserId) {
      state.pendingLosers.push(loserId); // Loser drops to losers bracket
    }
    
    state.winnersQueue.push(winnerId); // Winner goes to back of winners queue
    
    // Check if winners bracket round complete
    if (state.winnersQueue.length === 1) {
      // Winners champion! Switch to losers bracket
      state.currentBracket = 'losers';
      
      // Merge pending losers into losers queue
      if (state.pendingLosers.length > 0) {
        state.losersQueue.push(...state.pendingLosers);
        state.pendingLosers = [];
      }
    } else if (state.winnersQueue.length === 0 || (state.winnersQueue.length === 1 && state.losersQueue.length === 1)) {
      // Time for grand finals
      state.grandFinals = {
        a: state.winnersQueue[0],
        b: state.losersQueue[0]
      };
      state.winnersQueue = [];
      state.losersQueue = [];
    }
  }
  // Losers bracket
  else if (match.bracket === 'losers') {
    state.losersQueue.shift(); // Remove player A
    state.losersQueue.shift(); // Remove player B
    
    if (loserId) {
      state.eliminated.push(loserId); // Loser is eliminated (2nd loss)
    }
    
    state.losersQueue.push(winnerId); // Winner stays in losers bracket
    
    // Check if we need to merge more losers from winners
    if (state.losersQueue.length === 0 && state.pendingLosers.length > 0) {
      state.losersQueue.push(...state.pendingLosers);
      state.pendingLosers = [];
    }
    
    // Check if losers bracket round complete and winners still going
    if (state.losersQueue.length === 1 && state.winnersQueue.length > 1) {
      // Switch back to winners bracket
      state.currentBracket = 'winners';
    }
    
    // Check for grand finals
    if (state.winnersQueue.length === 1 && state.losersQueue.length === 1) {
      state.grandFinals = {
        a: state.winnersQueue[0],
        b: state.losersQueue[0]
      };
      state.winnersQueue = [];
      state.losersQueue = [];
    }
  }
  
  save();
  render();
}

function row(label, value) {
  return `<p><span>${label}:</span><span><b>${value || '-'}</b></span></p>`;
}

function card(c, side, bracketType) {
  // Don't show bracket badges - they're just for internal tracking
  return `
    <div class="card col">
      <h2 class="title">${c.name}</h2>
      <div class="profile">
        <div class="square">
          <img class="avatar" alt="${c.name}" src="${NAME_TO_URL[c.name] || imgSrc(c.filename)}"/>
        </div>
        <div class="details">
          ${row('From', c.details.from)}
          ${row('Age', c.details.age)}
          ${row('Height', c.details.height)}
          ${row('Birthday', c.details.birthday)}
          ${row('Zodiac', c.details.zodiac)}
          ${row('Blood', c.details.bloodType)}
          ${row('MBTI', c.details.mbti)}
        </div>
      </div>
      <div class="video">
        <iframe src="${c.video.embedUrl}" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      <button class="btn" onclick="choose('${c.id}')">Choose ${side}</button>
    </div>`;
}

function getFinalRankings() {
  return state.eliminated.slice().reverse();
}

function render() {
  load();
  
  // Update progress
  const total = getTotalMatches();
  const progress = Math.min(100, Math.round((state.totalMatches / total) * 100));
  const bar = document.querySelector('#progress > div');
  if (bar) bar.style.width = progress + '%';
  
  // Check if tournament complete
  if (state.eliminated.length === Object.keys(CONTESTANTS).length) {
    renderFinalResults();
    return;
  }
  
  const match = getCurrentMatch();
  
  // Handle BYEs
  if (match && match.b === null) {
    choose(match.a);
    return;
  }
  
  if (!match) {
    document.getElementById('content').innerHTML = '<div class="container"><h2 class="title">Advancing to next round...</h2></div>';
    setTimeout(render, 100);
    return;
  }
  
  const ca = CONTESTANTS[match.a];
  const cb = CONTESTANTS[match.b];
  
  // Show current progress without predicting total (since it varies with bracket resets)
  document.getElementById('roundTitle').textContent = `Match ${state.totalMatches + 1}`;
  document.getElementById('content').innerHTML = `<div class="row">${card(ca, 'Left', match.bracket)}<div class="vs">VS</div>${card(cb, 'Right', match.bracket)}</div>`;
}

function renderFinalResults() {
  const hdr = document.querySelector('.header');
  if (hdr) hdr.classList.add('hide');
  
  const rankings = getFinalRankings();
  
  const champId = rankings[0];
  const runnerId = rankings[1];
  const thirdId = rankings[2];
  
  const champ = CONTESTANTS[champId];
  const runner = runnerId ? CONTESTANTS[runnerId] : null;
  const third = thirdId ? CONTESTANTS[thirdId] : null;
  
  const cardP = (who, cls, rank) => who ? `
    <div class="${cls}">
      <div class="rank-badge">#${rank} ${rank === 1 ? 'Winner <span class="crown">👑</span>' : ''}</div>
      <img class="avatar" alt="${who.name}" src="${NAME_TO_URL[who.name] || imgSrc(who.filename)}"/>
      <div style="font-weight:800;margin-top:6px">${who.name}</div>
    </div>` : '';
  
  const rest = rankings.slice(3).map((id, i) => {
    const c = CONTESTANTS[id];
    const rank = i + 4;
    return `<div class="place-card">
      <div class="title-center">#${rank} ${c.name}</div>
      <img class="avatar" alt="${c.name}" src="${NAME_TO_URL[c.name] || imgSrc(c.filename)}"/>
    </div>`;
  }).join('');
  
  document.getElementById('roundTitle').textContent = '🏆 Tournament Complete 🏆';
  document.getElementById('content').innerHTML = `
    <div class="placements-wrap">
      <div class="champ-wrap">
        ${cardP(runner, 'runner', 2)}
        ${cardP(champ, 'champ', 1)}
        ${cardP(third, 'third', 3)}
      </div>
      <div class="list-wrap">${rest}</div>
    </div>`;
}

function resetApp() {
  localStorage.removeItem(STATE_KEY);
  location.reload();
}

window.addEventListener('DOMContentLoaded', render);
  </script>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="progress" id="progress"><div></div></div>
    </div>
  </div>
  <div class="container" style="display:flex;justify-content:center">
    <h1 id="roundTitle" class="title" style="margin:12px 0"></h1>
  </div>
  <main id="content" class="container"></main>
  <button class="btn reset" onclick="resetApp()">Reset</button>
</body>
</html>
